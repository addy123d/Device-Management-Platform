<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Project</title>
</head>

<body>
    <!-- <form action="/projectDetails" method="POST"> -->
    <input type="text" name="title" id="title" placeholder="Project Title" autocomplete="off">
    <input type="text" name="ip" id="ip" placeholder="Enter Ip" autocomplete="off">
    <input type="number" name="pinNumber" id="number" placeholder="Pins for device configuration" autocomplete="off">
    <textarea name="projDescription" id="description" placeholder="Project Description"></textarea>
    <button id="button">Generate</button>
    <!-- </form> -->

    <textarea id="code">

    </textarea>

    <!-- Response -->
    <div class="response" style="display: none;">
        <h2>Project Registered !</h2>
    </div>
</body>
<script>
    const title = document.querySelector("#title");
    const ip = document.querySelector("#ip");
    const number = document.querySelector("#number");
    const description = document.querySelector("#description");
    const button = document.querySelector("#button");
    const generatedCode = document.querySelector("#code");
    const response = document.querySelector(".response");

    //Click button
    button.addEventListener("click", function (event) {
        event.preventDefault();

        //Collect Values
        console.log("Title :", title.value);
        console.log("Ip :", ip.value);
        console.log("Number :", number.value);
        console.log("Description :", description.value);

        //LowerCasing
        let titleValue = title.value;
        titleValue = titleValue.toLowerCase();


        if (titleValue.includes("motor")) {
            code.value = `  const {Board, Servo} = require("johnny-five");
                            const board = new Board();

                            board.on("ready", () => {
                            const servo = new Servo(${number.value});

                            // Server Configuration
                            const express = require("express");
                            const fetch = require("node-fetch");
                            const host = "${ip.value}"";
                            const port = 3000;

                            const app = express();

                            app.get("/",function(request,response){
                                response.send("<a href = "/on"> Motor On</a> ")
                            })

                            app.get("/on",function(request,response){
                                //Blink
                                servo.sweep();

                                //Request platform server

                                fetch("http://127.0.0.1:5000/deviceping/<api_key>&<email>")
                                .then(response=>response.json())
                                .then((result)=>{
                                    console.log(result);
                                })
                                .catch(err=>console.log(err));

                                response.send("Motor is working !");
                            });

                            app.listen(port,host,function(){
                                console.log("Server is running...");
                            })


                            });`;
        }

        if (titleValue.includes("led") | titleValue.includes("blink")) {
            code.value = `const { Board, Led } = require("johnny-five");
                            const board = new Board();

                            board.on("ready", function() {
                            //Pin configuration
                            var led = new Led(13);

                            // Server Configuration
                            const express = require("express");
                            const fetch = require("node-fetch");
                            const host = "${ip.value}";
                            const port = 3000;

                            const app = express();

                            app.get("/",function(request,response){
                                response.send("< a href = "/on" > Led On</a > "");
                            })

                            app.get("/on",function(request,response){
                           
                                //Request platform server
                                fetch("http://127.0.0.1:5000/deviceping/<api_key>&<email>")
                                .then(response=>response.json())
                                .then((result)=>{
                                    console.log(result);
                                    //Blink
                                    if(result.error === 'You are not allowed !' || result.error === "Max calls exceeded !"){
                                        response.send(result.error);
                                    }else{
                                        led.blink(1500);
                                        response.send("Connected !");
                                    }
                                })
                                .catch(err=>console.log(err));
                                });

                            app.listen(port,host,function(){
                                console.log("Server is running...");
                            })


                            });`;
        }

        // if (titleValue.includes("sensor")) {
        //     console.log("Sensor code...Now not available !");
        //     code.value = "Sensor code...Now not available !";
        // }

        const options = {
            method: "POST",
            body: JSON.stringify({
                title: title.value,
                ip: ip.value,
                pinNumber: number.value,
                projDescription: description.value
            }),
            headers: new Headers({ 'Content-Type': 'application/json' })
        };

        fetch("/projectDetails", options)
            .then(response => response.json())
            .then(function (data) {
                console.log("Data sent successfully !");
                if (data) {
                    response.style.display = "block";
                }
            })
            .catch(function (err) {
                console.log(err);
                return err;
            });

        //Reset all values
        title.value = "";
        ip.value = "";
        number.value = "";
        description.value = "";

    })
</script>

</html>